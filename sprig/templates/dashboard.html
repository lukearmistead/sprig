<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Sprig</title>
</head>
<body>
    <h1>Sprig</h1>

    <form action="/sync" method="post">
        <p>
            <label>APP_ID: <input name="app_id" value="{{ app_id }}" size="40"></label>
        </p>
        <p>
            <label>Claude API Key: <input name="claude_key" type="password" placeholder="{{ claude_key_masked }}" size="40"></label>
        </p>
        <p>
            Certificates: Save to <code>{{ certs_dir }}/</code>
            <br><small>(certificate.pem and private_key.pem)</small>
        </p>
        <p>
            {% if has_bank %}
            Bank: {{ bank_count }} account(s) connected
            {% else %}
            Bank: Not connected
            {% endif %}
            - <a href="/auth/connect">Connect Bank</a>
        </p>
        <hr>
        <p>
            <button type="submit" id="sync-btn">Sync Now</button>
        </p>
    </form>

    <p id="status">{% if status %}{{ status }}{% endif %}</p>

    <p>
        Exports: <a href="file://{{ exports_dir }}">{{ exports_dir }}</a>
    </p>

    <script>
        (function() {
            var state = {{ sync_state | tojson }};
            if (state.status === "running") {
                poll();
            }

            function poll() {
                document.getElementById("sync-btn").disabled = true;
                document.getElementById("status").textContent = state.message || "Syncing...";

                var interval = setInterval(function() {
                    fetch("/sync/status")
                        .then(function(r) { return r.json(); })
                        .then(function(data) {
                            document.getElementById("status").textContent = data.message;
                            if (data.status !== "running") {
                                clearInterval(interval);
                                document.getElementById("sync-btn").disabled = false;
                            }
                        });
                }, 2000);
            }

            document.querySelector("form").addEventListener("submit", function() {
                if (state.status !== "running") {
                    state.status = "running";
                    state.message = "Starting sync...";
                    setTimeout(poll, 500);
                }
            });
        })();
    </script>
</body>
</html>
